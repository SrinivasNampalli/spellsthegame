import { canvas, game } from './context.js';
import { items } from './data.js';
import { sprites, drawSprite } from './assets.js';
import { clamp, relaxEntitySpacing } from './utils.js';
import { countItemInInventory, consumeItemsFromInventory, giveItemsToPlayer } from './resources.js';
import { saveGameState } from './persistence.js';
import { showDialogue } from './ui.js';
import { spawnTrainingDroids } from './combat.js';

export class NPC {
  constructor(x, y, name, dialogues, color = '#00ff00', spriteKey = null, itemGift = null) {
    this.x = x;
    this.y = y;
    this.width = 48;
    this.height = 72;
    this.name = name;
    this.dialogues = dialogues;
    this.color = color;
    this.dialogueIndex = 0;
    this.interactionRange = 80;
    this.spriteKey = spriteKey;
    this.itemGift = itemGift; // string or [{id,count}]
    this.hasGivenItem = false;

    // Layout
    this.biome = 'home';
    this.anchor = null;
    this.anchors = null;

    // Optional quest
    this.quest = null; // { requires:[{id,count}], rewards:[{id,count}], completeText:string }
    this.questComplete = false;

    // Custom interactive dialogue handler
    this.customDialogueHandler = null;
  }

  draw(ctx) {
    if (this.spriteKey && sprites.loaded && sprites[this.spriteKey]) {
      drawSprite(ctx, sprites[this.spriteKey], this.x, this.y, this.width, this.height, this.spriteKey);
    } else {
      ctx.fillStyle = this.color;
      ctx.fillRect(this.x, this.y, this.width, this.height);
    }
    this.drawNameTag(ctx);
  }

  drawNameTag(ctx) {
    const tagWidth = this.width + 20;
    const tagHeight = 16;
    const tagX = this.x - 10;
    const tagY = this.y - 20;

    ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
    ctx.fillRect(tagX, tagY, tagWidth, tagHeight);
    ctx.fillStyle = '#ffcc00';
    ctx.font = '10px monospace';
    ctx.textAlign = 'center';
    ctx.fillText(this.name, this.x + this.width / 2, this.y - 8);
  }

  canInteract(player) {
    const dx = player.x - this.x;
    const dy = player.y - this.y;
    const distance = Math.sqrt(dx * dx + dy * dy);
    return distance < this.interactionRange;
  }

  getNextDialogue() {
    const dialogue = this.dialogues[this.dialogueIndex];
    this.dialogueIndex = (this.dialogueIndex + 1) % this.dialogues.length;
    return dialogue;
  }
}

export function tryCompleteQuest(npc) {
  if (!npc?.quest) return null;
  if (npc.questComplete) return null;

  const requires = npc.quest.requires || [];
  for (const req of requires) {
    if (countItemInInventory(req.id) < (req.count ?? 1)) return null;
  }

  for (const req of requires) {
    consumeItemsFromInventory(req.id, req.count ?? 1);
  }

  const rewards = npc.quest.rewards || [];
  giveItemsToPlayer(rewards);

  npc.questComplete = true;
  saveGameState();
  return npc.quest.completeText || `${npc.name}: Nice. Here's your reward.`;
}

export function layoutNPCsForBiome(biomeKey) {
  const biomeNPCs = game.npcs.filter((n) => (n.biome || 'home') === biomeKey);
  if (!biomeNPCs.length) return;

  const margin = 40;
  for (const npc of biomeNPCs) {
    const anchor = npc.anchors?.[biomeKey] || npc.anchor || null;
    if (!anchor) continue;
    npc.x = clamp(anchor.x * canvas.width - npc.width / 2, margin, canvas.width - npc.width - margin);
    npc.y = clamp(anchor.y * canvas.height - npc.height / 2, margin, canvas.height - npc.height - margin);
  }

  relaxEntitySpacing(biomeNPCs, 140, 12);

  for (const npc of biomeNPCs) {
    npc.x = clamp(npc.x, margin, canvas.width - npc.width - margin);
    npc.y = clamp(npc.y, margin, canvas.height - npc.height - margin);
  }
}

export function createNPCs() {
  game.npcs = [];

  // STORY PROGRESSION: Elder Mage - The Beginning
  const elderMage = new NPC(
    0,
    0,
    'Elder Mage',
    [
      "Ah, you've awakened... Good. I am Elder Sage, keeper of this realm.",
      'The world beyond these walls has grown dark. Ancient evils stir.',
      'You possess the spark of magic within you. I can help you harness it.',
      'Take these basic materials. Learn to survive first.',
      'When you are ready, seek me again. I will open the path to the Great Library.',
      'There, the Archive Keeper will teach you the art of crafting.',
      'But beware... knowledge comes at a price. Are you ready?',
      'Press E again to journey to the Mystical Library...',
    ],
    '#8844ff',
    'elderMage',
    [{ id: 'wood', count: 3 }, { id: 'berry', count: 2 }],
  );
  elderMage.teleportTo = 'mysticalLibrary';
  elderMage.biome = 'home';
  elderMage.anchor = { x: 0.5, y: 0.5 }; // Center of home
  elderMage.onFirstMeet = () => {
    // Unlock crafting when first meeting Elder Mage
    game.craftingUnlocked = true;
    saveGameState();
  };
  game.npcs.push(elderMage);

  // STORY: Archive Keeper - The Tutorial (Mystical Library)
  const archiveKeeper = new NPC(
    0,
    0,
    'Archive Keeper',
    [
      'Welcome to the Great Library, young one. I am the Archive Keeper.',
      'These halls contain the sum of all knowledge - crafting, magic, forbidden secrets...',
      'The Elder Sage believes you worthy. But I... I must test this claim myself.',
      '...',
      'CRAFTING: Press C to open your table. Combine items - try 2 Wood into 4 Sticks.',
      'MAGIC: Take this Fire Spell. Select it (1-9), aim with mouse, press F to cast. Uses 10 mana.',
      'Practice makes perfect. Or in your case... practice makes survival possible.',
      '...',
      'Now comes the price. Knowledge is never free, child.',
      'Two Training Droids will test your skills. Defeat them, and the path opens.',
      'Fail... well. We both know what failure means here.',
      'Ready yourself. The trial begins... NOW!',
    ],
    '#cc66ff',
    null,
    [{ id: 'fire_spell', count: 1 }],
  );
  archiveKeeper.biome = 'mysticalLibrary';
  archiveKeeper.anchor = { x: 0.5, y: 0.3 };

  // Override dialogue for post-trial
  archiveKeeper.getNextDialogue = function() {
    // Post-trial unlock
    if (game.trialCompleted && !this._postTrialShown) {
      this._postTrialShown = true;
      this.dialogueIndex = 0;
      this.dialogues = [
        'Excellent work! You\'ve proven yourself worthy.',
        'The library\'s INNER SANCTUM is now unlocked.',
        'Three magical stations await you:',
        'âš—ï¸ Alchemy Crucible (left) - Combine materials',
        'ðŸ”® Runic Altar (center) - Pattern memory game',
        'ðŸ“š Memory Tome (right) - Symbol memorization',
        'Explore them to gain power and knowledge!',
      ];
      game.alchemyStationActive = true;
      game.runicPuzzleActive = true;
      game.tomeMemoryActive = true;
    }

    const dialogue = this.dialogues[this.dialogueIndex];
    this.dialogueIndex = (this.dialogueIndex + 1) % this.dialogues.length;
    return dialogue;
  };

  game.npcs.push(archiveKeeper);

  // Water Queen access gate (unlocked after Library trial)
  const tideGate = new NPC(

    if (this._dialoguePhase === 0) {
      // Initial greeting
      showDialogue(this.name,
        'Welcome to the Great Library, young one. I am the Archive Keeper. These halls contain the sum of all knowledge... crafting, magic, and forbidden secrets.',
        [
          {
            text: 'I seek knowledge to protect others.',
            nextDialogue: 'Ah, the noble path. Admirable... but is nobility enough when darkness rises?',
            nextChoices: [
              {
                text: 'Strength comes from conviction.',
                callback: () => {
                  this._pathChosen = 'noble';
                  this._dialoguePhase = 1;
                },
                nextDialogue: 'Conviction without skill is merely stubborn suicide. Let me teach you to survive first...'
              },
              {
                text: 'Show me how to fight.',
                callback: () => {
                  this._pathChosen = 'pragmatic';
                  this._dialoguePhase = 1;
                },
                nextDialogue: 'Pragmatic. Good. Dead heroes save no one. Let me teach you the fundamentals...'
              }
            ]
          },
          {
            text: 'I seek power for myself.',
            nextDialogue: 'Honest, at least. Power without wisdom destroys its wielder... but perhaps you can learn.',
            nextChoices: [
              {
                text: 'I will master whatever you teach.',
                callback: () => {
                  this._pathChosen = 'ambitious';
                  this._dialoguePhase = 1;
                },
                nextDialogue: 'Ambition. A double-edged blade. Very well, let us see if you can handle it...'
              },
              {
                text: 'Just give me the magic already.',
                callback: () => {
                  this._pathChosen = 'reckless';
                  this._dialoguePhase = 1;
                },
                nextDialogue: 'Impatient AND reckless. This will be... entertaining. Let me show you the basics before you kill yourself...'
              }
            ]
          },
          {
            text: 'I don\'t know what I seek yet.',
            nextDialogue: 'Uncertainty... not weakness, but honesty. The wise admit what they do not know.',
            nextChoices: [
              {
                text: 'Then help me find my path.',
                callback: () => {
                  this._pathChosen = 'seeker';
                  this._dialoguePhase = 1;
                },
                nextDialogue: 'A seeker of truth. Rare in these dark times. Let me guide you through the fundamentals...'
              }
            ]
          }
        ]
      );
    } else if (this._dialoguePhase === 1) {
      // Teaching phase - triggered by choices
      const pathText = this._pathChosen === 'reckless' ?
        'Since you\'re so eager, let\'s start with the dangerous stuff first.' :
        'First, the fundamentals. Pay attention - this knowledge has saved countless lives.';

      showDialogue(this.name,
        pathText + '\n\nCRAFTING: Press C to open your crafting table. Combine items in the 3x3 grid. Try: 2 Wood â†’ 4 Sticks.',
        [
          {
            text: 'Understood. What else?',
            callback: () => {
              this._dialoguePhase = 2;
            },
            nextDialogue: 'MAGIC. Here - take this Fire Spell. It\'s ancient, powerful, and volatile. Select it with 1-9, aim with your mouse, press F to cast. Costs 10 mana per shot.'
          }
        ]
      );
    } else if (this._dialoguePhase === 2) {
      // Final warning before trial
      const trialText = this._pathChosen === 'reckless' ?
        'Now comes the fun part. I\'m activating two Training Droids. Try not to die immediately.' :
        'Knowledge demands payment, child. Two Training Droids will test everything I just taught you.';

      showDialogue(this.name,
        trialText + '\n\nDefeat them both to prove you can survive. Fail, and... well. The archives have seen many failures.',
        [
          {
            text: 'I\'m ready. Bring them on!',
            callback: () => {
              spawnTrainingDroids();
              this._dialoguePhase = 3;
            },
            nextDialogue: 'The trial begins. Survive, and I shall teach you more. Good luck!'
          },
          {
            text: 'Wait, can you explain again?',
            callback: () => { this._dialoguePhase = 1; },
            nextDialogue: 'Very well. A wise warrior knows when to ask questions...'
          }
        ]
      );
    } else if (this._dialoguePhase === 3) {
      // During trial
      if (!game.trialCompleted) {
        showDialogue(this.name, 'The trial has begun. Survive, and the path forward opens. Good luck, young one.');
      } else {
        // Post-trial celebration and new activities
        this._dialoguePhase = 4;
        this.customDialogueHandler();
      }
    } else if (this._dialoguePhase === 4) {
      // Post-trial rewards and activities unlock
      const congratsText = this._pathChosen === 'reckless' ?
        'Well, well! You actually survived. Color me impressed. You\'ve earned more than just passage forward.' :
        'Excellent work! You\'ve proven yourself worthy. The true knowledge of this library is now yours to explore.';

      showDialogue(this.name,
        congratsText + '\n\nI shall unlock the library\'s INNER SANCTUM. Three stations await you...',
        [
          {
            text: 'What kind of stations?',
            nextDialogue: 'âš—ï¸ The ALCHEMY CRUCIBLE - Combine materials to create powerful potions and artifacts.\n\nðŸ”® The RUNIC ALTAR - Weave elemental energies into new spells.\n\nðŸ“š The MEMORY TOME - Ancient knowledge awaits those who can unlock its secrets.',
            nextChoices: [
              {
                text: 'I want to try the Alchemy Crucible!',
                callback: () => {
                  game.alchemyStationActive = true;
                  this._dialoguePhase = 5;
                },
                nextDialogue: 'Step to the glowing crucible on the left. Combine items from your inventory - who knows what you\'ll discover?'
              },
              {
                text: 'Show me the Runic Altar.',
                callback: () => {
                  game.runicPuzzleActive = true;
                  this._dialoguePhase = 5;
                },
                nextDialogue: 'Approach the altar in the center. Match the runes to harness their power. Be warned - one mistake and the spell collapses!'
              },
              {
                text: 'The Memory Tome sounds interesting.',
                callback: () => {
                  game.tomeMemoryActive = true;
                  this._dialoguePhase = 5;
                },
                nextDialogue: 'The ancient tome on the right pedestal holds forgotten lore. Remember the pattern it shows... failure means starting over.'
              },
              {
                text: 'I\'ll explore on my own.',
                callback: () => {
                  game.alchemyStationActive = true;
                  game.runicPuzzleActive = true;
                  game.tomeMemoryActive = true;
                  this._dialoguePhase = 5;
                },
                nextDialogue: 'Independent as ever. All three stations are active. Return when you seek guidance... or when you\'re ready to leave this realm.'
              }
            ]
          }
        ]
      );
    } else if (this._dialoguePhase === 5) {
      // After activities unlocked
      const activitiesText = [];
      if (game.alchemyStationActive) activitiesText.push('âš—ï¸ Alchemy Crucible (left)');
      if (game.runicPuzzleActive) activitiesText.push('ðŸ”® Runic Altar (center)');
      if (game.tomeMemoryActive) activitiesText.push('ðŸ“š Memory Tome (right)');

      const allActive = game.alchemyStationActive && game.runicPuzzleActive && game.tomeMemoryActive;

      if (!allActive) {
        showDialogue(this.name,
          'The library\'s stations are ready for you:\n\n' + activitiesText.join('\n') + '\n\nExperiment, learn, and grow stronger.',
          [
            {
              text: 'Unlock all activities for me.',
              callback: () => {
                game.alchemyStationActive = true;
                game.runicPuzzleActive = true;
                game.tomeMemoryActive = true;
              },
              nextDialogue: 'Very well. All three stations are now active. May your discoveries be profound.'
            }
          ]
        );
      } else {
        showDialogue(this.name, 'All stations are active. Continue your studies, or venture onward to the Water Realm when ready. The choice is yours.');
      }
    }
  };

  game.npcs.push(archiveKeeper);

  // Water Queen access gate (unlocked after Library trial)
  const tideGate = new NPC(
    0,
    0,
    'Tide Gate',
    [
      'The sea calls... Step through and do not look back.',
      'The Water Queen is watching.',
      'Press E again to enter the Water Queen Realm...',
    ],
    '#66ccff',
    null,
    null,
  );
  tideGate.biome = 'mysticalLibrary';
  tideGate.anchor = { x: 0.86, y: 0.36 };
  tideGate.getNextDialogue = function getNextDialogue() {
    if (!game.flags?.waterUnlocked) {
      this.dialogueIndex = 0;
      this.teleportTo = null;
      return 'Locked. Defeat the Training Droids to unseal this gate.';
    }
    this.teleportTo = 'waterQueenRealm';
    return NPC.prototype.getNextDialogue.call(this);
  };
  game.npcs.push(tideGate);

  const forgeWarden = new NPC(
    0,
    0,
    'Forge Warden',
    ['Mind your step. The magma listens.', "Bring 3 Iron Ingots and I'll temper a blade.", 'Smelt ore with Fire Essence.'],
    '#ff8844',
    null,
    null,
  );
  forgeWarden.biome = 'magmaKingdom';
  forgeWarden.anchor = { x: 0.7, y: 0.58 };
  forgeWarden.quest = {
    requires: [{ id: 'iron_ingot', count: 3 }],
    rewards: [{ id: 'iron_sword', count: 1 }],
    completeText: 'Forge Warden: Good metal. Take this Iron Sword and keep moving.',
  };
  game.npcs.push(forgeWarden);

  const tideScout = new NPC(
    0,
    0,
    'Tide Scout',
    ['Currents are shifting...', "Bring 3 Water Drops and I'll mix a Mana Potion.", 'Hydration is power.'],
    '#66aaff',
    null,
    null,
  );
  tideScout.biome = 'waterQueenRealm';
  tideScout.anchor = { x: 0.25, y: 0.52 };
  tideScout.quest = {
    requires: [{ id: 'water_drop', count: 3 }],
    rewards: [{ id: 'potion_mana', count: 1 }],
    completeText: "Tide Scout: There. One Mana Potion. Don't waste it.",
  };
  game.npcs.push(tideScout);

  const waterQueen = new NPC(
    0,
    0,
    'Water Queen',
    [
      'A surface dweller... in MY realm. How bold. Or foolish.',
      'You carry the scent of magic. The Archive Keeper sent you, did he not?',
      'That old fool thinks to test you with mere droids. Pathetic.',
      '...',
      'I shall show you REAL danger. My minions will tear you apart.',
      'Survive, and bring me 3 Water Cores from their remains.',
      'Prove your worth, mortal. Or drown trying.',
      'The hunt... begins NOW!',
    ],
    '#66ccff',
    'waterQueen',
    null,
  );
  waterQueen.biome = 'waterQueenRealm';
  waterQueen.anchor = { x: 0.52, y: 0.34 };
  waterQueen.quest = {
    requires: [{ id: 'water_core', count: 3 }],
    rewards: [
      { id: 'potion_mana', count: 1 },
      { id: 'mana_crystal', count: 1 },
    ],
    completeText: 'Water Queen: Accept my blessing. Do not waste it.',
  };
  game.npcs.push(waterQueen);

  const voidEcho = new NPC(
    0,
    0,
    'Corrupted Echo',
    ['â€¦you are not supposed to be hereâ€¦', 'Feed the void 1 Mana Crystal. It will spit out something.', 'â€¦or harmfulâ€¦'],
    '#ff3355',
    null,
    null,
  );
  voidEcho.biome = 'glitchedVoid';
  voidEcho.anchor = { x: 0.5, y: 0.45 };
  voidEcho.quest = {
    requires: [{ id: 'mana_crystal', count: 1 }],
    rewards: [
      { id: 'fire_essence', count: 2 },
      { id: 'air_feather', count: 2 },
    ],
    completeText: 'Corrupted Echo: It takesâ€¦ it givesâ€¦ take these.',
  };
  game.npcs.push(voidEcho);

  // Ensure any gift items exist
  for (const npc of game.npcs) {
    if (!npc.itemGift) continue;
    if (Array.isArray(npc.itemGift)) {
      npc.itemGift = npc.itemGift.filter((g) => !!items[g.id]);
    } else if (!items[npc.itemGift]) {
      npc.itemGift = null;
    }
  }
}
